<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"liyun-666.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="OP 没有办法控制的事情太多了。人家会常说你为什么要运动，因为跑步是一件很简单的事情，左脚比右脚往前，就这样而已，没有什么难的。但是今天如果我们在开工前、上班前，能挪出时间，哪怕 20 分钟的做普拉提或者是半个小时的跑步，我设定的 plan，我做了 check，我冲了一杯咖啡，我做了 check。那么我就会觉得，我今天有点不太一样，有点自信。我今天看到异性也有点自信，我看到老板，我也觉得你说什么我">
<meta property="og:type" content="article">
<meta property="og:title" content="Lab Page tables">
<meta property="og:url" content="https://liyun-666.github.io/2022/04/19/2022-4-19/index.html">
<meta property="og:site_name" content="黎酝的博客">
<meta property="og:description" content="OP 没有办法控制的事情太多了。人家会常说你为什么要运动，因为跑步是一件很简单的事情，左脚比右脚往前，就这样而已，没有什么难的。但是今天如果我们在开工前、上班前，能挪出时间，哪怕 20 分钟的做普拉提或者是半个小时的跑步，我设定的 plan，我做了 check，我冲了一杯咖啡，我做了 check。那么我就会觉得，我今天有点不太一样，有点自信。我今天看到异性也有点自信，我看到老板，我也觉得你说什么我">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://liyun-666.github.io/2022/04/19/2022-4-19/2022-4-19_1.png">
<meta property="og:image" content="https://liyun-666.github.io/2022/04/19/2022-4-19/2022-4-19_2.png">
<meta property="og:image" content="https://liyun-666.github.io/2022/04/19/2022-4-19/2022-4-19_3.png">
<meta property="article:published_time" content="2022-04-19T02:12:36.000Z">
<meta property="article:modified_time" content="2022-04-19T02:12:36.000Z">
<meta property="article:author" content="黎酝">
<meta property="article:tag" content="MIT 6.S081">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://liyun-666.github.io/2022/04/19/2022-4-19/2022-4-19_1.png">


<link rel="canonical" href="https://liyun-666.github.io/2022/04/19/2022-4-19/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://liyun-666.github.io/2022/04/19/2022-4-19/","path":"2022/04/19/2022-4-19/","title":"Lab Page tables"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Lab Page tables | 黎酝的博客</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">黎酝的博客</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
        <li class="menu-item menu-item-resources"><a href="/resources/" rel="section"><i class="fa fa-download fa-fw"></i>资源</a></li>
        <li class="menu-item menu-item-moments"><a href="/moments/" rel="section"><i class="fa fa-trash fa-fw"></i>日常</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#OP"><span class="nav-number">1.</span> <span class="nav-text">OP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Speed-up-system-calls-easy"><span class="nav-number">3.</span> <span class="nav-text">Speed up system calls (easy)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Print-a-page-table-easy"><span class="nav-number">4.</span> <span class="nav-text">Print a page table (easy)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Detecting-which-pages-have-been-accessed-hard"><span class="nav-number">5.</span> <span class="nav-text">Detecting which pages have been accessed (hard)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E7%BB%93%E6%9E%9C"><span class="nav-number">6.</span> <span class="nav-text">实验结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E9%AA%8C%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">实验总结</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="黎酝"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">黎酝</p>
  <div class="site-description" itemprop="description">爱意东升日落，浪漫至死不渝</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/LiYun-666" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;LiYun-666" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:liyun2389231032@gmail.com" title="E-Mail → mailto:liyun2389231032@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://liyun-666.github.io/2022/04/19/2022-4-19/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="黎酝">
      <meta itemprop="description" content="爱意东升日落，浪漫至死不渝">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="黎酝的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Lab Page tables
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-19 10:12:36" itemprop="dateCreated datePublished" datetime="2022-04-19T10:12:36+08:00">2022-04-19</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MIT-6-S081/" itemprop="url" rel="index"><span itemprop="name">MIT 6.S081</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="OP"><a href="#OP" class="headerlink" title="OP"></a>OP</h2><blockquote>
<p>没有办法控制的事情太多了。<br>人家会常说你为什么要运动，因为跑步是一件很简单的事情，左脚比右脚往前，就这样而已，没有什么难的。<br>但是今天如果我们在开工前、上班前，能挪出时间，哪怕 20 分钟的做普拉提或者是半个小时的跑步，我设定的 plan，我做了 check，我冲了一杯咖啡，我做了 check。<br>那么我就会觉得，我今天有点不太一样，有点自信。我今天看到异性也有点自信，我看到老板，我也觉得你说什么我都没问题。<br>因为我已经很强大，我今天该做的都做了。<br>我练了四十分钟的健身，很重的训练，你的工作打击不到我，我规定自己的 40 分钟运动全部做到了。如果我能够做到，我就没有问题。<br>可是如果我规定我要做够 40 分钟，但我只坚持了 5 分钟就放弃了。那这个就是你的问题了，因为你自己都没办法控制你自己，那你怎么能够控制外界那些不定未知的东西呢？<br>—————————————–《一段来自彭于晏的采访》</p>
</blockquote>
<p><img src="/2022/04/19/2022-4-19/2022-4-19_1.png"></p>
<p>人需要身材管理、时间管理… 操作系统需要内存管理，而内存管理中的一个重要结构就是页表。人可以通过一个 Schedule 管理自己，操作系统通过页表对内存进行管理。</p>
<span id="more"></span>

<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>这是本次 <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2021/labs/pgtbl.html">lab 指引</a>，关于实验环境和实验资料等更加详细的内容请查看 <strong>我的第一个 lab</strong> – <strong>Lab Utilities</strong>。</p>
<p>本次实验我们将探索内存管理的重要机制 – 分页管理。</p>
<blockquote>
<p>实验开始前需要阅读 xv6 book 第三章以及下列文件：</p>
<ol>
<li>kern/memlayout.h, which captures the layout of memory.</li>
<li>kern/vm.c, which contains most virtual memory (VM) code.</li>
<li>kernel/kalloc.c, which contains code for allocating and freeing physical memory.</li>
</ol>
</blockquote>
<p>首先建立好实验环境。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git fetch</span><br><span class="line">git checkout pgtbl</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>

<h2 id="Speed-up-system-calls-easy"><a href="#Speed-up-system-calls-easy" class="headerlink" title="Speed up system calls (easy)"></a>Speed up system calls (easy)</h2><p>执行系统调用时，CPU 要在内核态与用户态之间切换，需要一定的开销，我们可以对系统调用进行加速，方法就是为每个进程多分配一个页面，在 <code>TRAPFRAME</code> 的下面，然后内核往这个页面地址写入内容即可。这样的话，执行系统调用的时候，就可以直接从用户空间取出数据来，不需要进入内核态了。</p>
<p><img src="/2022/04/19/2022-4-19/2022-4-19_2.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// user/ulib.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LAB_PGTBL</span></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">ugetpid</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">usyscall</span> *<span class="title">u</span> =</span> (struct usyscall *)USYSCALL;</span><br><span class="line">  <span class="keyword">return</span> u-&gt;pid;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p><code>ugetpid()</code> 系统调用直接从 <code>USYSCALL</code> 这个地址取数据。</p>
<p>kalloc() 内核在内存中找到一个空闲页面，为进程分配这个空闲页面，对于进程来说，这个页面在物理上大概率跟进程的其他页面是不连续的，所以需要映射到他自己的空间也就是 <code>trapframe</code> 的下面，使得在进程看来，这个页面是跟 <code>trapframe</code> 连续的，所以需要 <code>mappage</code>。这个页的内容是一个 <code>usyscall</code> 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/memlayout.h</span></span><br><span class="line"><span class="comment">// 这个是灰色的没关系，不用管。</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LAB_PGTBL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> USYSCALL (TRAPFRAME - PGSIZE)  <span class="comment">// USYSCALl = 3FFFFFD000</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">usyscall</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> pid;  <span class="comment">// Process ID</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>首先为进程添加 <code>usyscall</code> 指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proc</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// p-&gt;lock must be held when using these:</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">procstate</span> <span class="title">state</span>;</span>        <span class="comment">// Process state</span></span><br><span class="line">  <span class="keyword">void</span> *chan;                  <span class="comment">// If non-zero, sleeping on chan</span></span><br><span class="line">  <span class="keyword">int</span> killed;                  <span class="comment">// If non-zero, have been killed</span></span><br><span class="line">  <span class="keyword">int</span> xstate;                  <span class="comment">// Exit status to be returned to parent&#x27;s wait</span></span><br><span class="line">  <span class="keyword">int</span> pid;                     <span class="comment">// Process ID</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// wait_lock must be held when using this:</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">parent</span>;</span>         <span class="comment">// Parent process</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// these are private to the process, so p-&gt;lock need not be held.</span></span><br><span class="line">  uint64 kstack;               <span class="comment">// Virtual address of kernel stack</span></span><br><span class="line">  uint64 sz;                   <span class="comment">// Size of process memory (bytes)</span></span><br><span class="line">  <span class="keyword">pagetable_t</span> pagetable;       <span class="comment">// User page table</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">trapframe</span> *<span class="title">trapframe</span>;</span> <span class="comment">// data page for trampoline.S</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">usyscall</span> *<span class="title">usyscall</span>;</span>   <span class="comment">// ！添加！</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">context</span> <span class="title">context</span>;</span>      <span class="comment">// swtch() here to run process</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">ofile</span>[<span class="title">NOFILE</span>];</span>  <span class="comment">// Open files</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">cwd</span>;</span>           <span class="comment">// Current directory</span></span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">16</span>];               <span class="comment">// Process name (debugging)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
<li><p>然后在为进程分配这个页面：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct proc*</span></span><br><span class="line"><span class="function"><span class="title">allocproc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ................</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Allocate a trapframe page.</span></span><br><span class="line">  <span class="keyword">if</span>((p-&gt;trapframe = (struct trapframe *)kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">    freeproc(p);</span><br><span class="line">    release(&amp;p-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加：分配一个 usyscall 页面</span></span><br><span class="line">  <span class="keyword">if</span>((p-&gt;usyscall = (struct usyscall *)kalloc()) == <span class="number">0</span>)&#123;</span><br><span class="line">    freeproc(p);</span><br><span class="line">    release(&amp;p-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// An empty user page table.</span></span><br><span class="line">  p-&gt;pagetable = proc_pagetable(p);</span><br><span class="line">  </span><br><span class="line">  ..............</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>然后在 <code>proc_pagetable()</code> 中进行映射：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="function"><span class="keyword">pagetable_t</span></span></span><br><span class="line"><span class="function"><span class="title">proc_pagetable</span><span class="params">(struct proc *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ......</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加！！！</span></span><br><span class="line">  <span class="keyword">if</span> (mappages(pagetable, USYSCALL, PGSIZE,</span><br><span class="line">              (uint64)(p-&gt;usyscall), PTE_R | PTE_U) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">    uvmunmap(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>); <span class="comment">// 映射失败需要释放</span></span><br><span class="line">    uvmunmap(pagetable, TRAPFRAME, <span class="number">1</span>, <span class="number">0</span>);  <span class="comment">// 映射失败需要释放</span></span><br><span class="line">    uvmfree(pagetable, <span class="number">0</span>);                 <span class="comment">// 映射失败需要释放</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> pagetable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>映射完成，初始化即可，将进程的 pid 写入到映射的页面：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct proc*</span></span><br><span class="line"><span class="function"><span class="title">allocproc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ............</span><br><span class="line"></span><br><span class="line">  p-&gt;usyscall-&gt;pid = p-&gt;pid;</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>然后进程回收的时候需要解除映射和回收页面：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">freeproc</span><span class="params">(struct proc *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ........</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(p-&gt;usyscall)</span><br><span class="line">    kfree((<span class="keyword">void</span>*)p-&gt;usyscall);</span><br><span class="line">  p-&gt;usyscall = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/proc.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">proc_freepagetable</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 sz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uvmunmap(pagetable, TRAMPOLINE, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmunmap(pagetable, TRAPFRAME, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmunmap(pagetable, USYSCALL, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  uvmfree(pagetable, sz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>可以忽略掉上述过程中产生的报错信息，因为是没有 #define LAB_PGTBL，编译的时候会自动加上的，所以不用理。</p>
</blockquote>
<h2 id="Print-a-page-table-easy"><a href="#Print-a-page-table-easy" class="headerlink" title="Print a page table (easy)"></a>Print a page table (easy)</h2><p>三层 for 循环打印三级页表内容即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/vm.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vmprint</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;page table %p\n&quot;</span>, pagetable);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 一级页表</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">512</span>; ++i)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">pte_t</span> top_pte = pagetable[i];</span><br><span class="line">    <span class="keyword">if</span> (top_pte &amp; PTE_V)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;..%d: pte %p pa %p\n&quot;</span>, i, top_pte, PTE2PA(top_pte));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 二级页表</span></span><br><span class="line">      <span class="keyword">pagetable_t</span> mid_table = (<span class="keyword">pagetable_t</span>)PTE2PA(top_pte);</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">512</span>; ++j)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">pte_t</span> mid_pte = mid_table[j];</span><br><span class="line">        <span class="keyword">if</span> (mid_pte &amp; PTE_V)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">&quot;.. ..%d: pte %p pa %p\n&quot;</span>, j, mid_pte, PTE2PA(mid_pte));</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 三级页表</span></span><br><span class="line">          <span class="keyword">pagetable_t</span> bot_table = (<span class="keyword">pagetable_t</span>)PTE2PA(mid_pte);</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="number">512</span>; ++k)</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">pte_t</span> bot_pte = bot_table[k];</span><br><span class="line">            <span class="keyword">if</span> (bot_pte &amp; PTE_V)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;.. .. ..%d: pte %p pa %p\n&quot;</span>, k, bot_pte, PTE2PA(bot_pte));</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在 kernel/defs.h 中声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/defs.h</span></span><br><span class="line">.............</span><br><span class="line"><span class="comment">// vm.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">kvminit</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">kvminithart</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">kvmmap</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64, uint64, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">mappages</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64, uint64, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">pagetable_t</span>     <span class="title">uvmcreate</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">uvminit</span><span class="params">(<span class="keyword">pagetable_t</span>, uchar *, uint)</span></span>;</span><br><span class="line"><span class="function">uint64          <span class="title">uvmalloc</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64)</span></span>;</span><br><span class="line"><span class="function">uint64          <span class="title">uvmdealloc</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">uvmcopy</span><span class="params">(<span class="keyword">pagetable_t</span>, <span class="keyword">pagetable_t</span>, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">uvmfree</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">uvmunmap</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">uvmclear</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64)</span></span>;</span><br><span class="line"><span class="function">uint64          <span class="title">walkaddr</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">copyout</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, <span class="keyword">char</span> *, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">copyin</span><span class="params">(<span class="keyword">pagetable_t</span>, <span class="keyword">char</span> *, uint64, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">copyinstr</span><span class="params">(<span class="keyword">pagetable_t</span>, <span class="keyword">char</span> *, uint64, uint64)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">vmprint</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable)</span></span>; <span class="comment">// 添加</span></span><br><span class="line">.............</span><br></pre></td></tr></table></figure>

<p>在 <code>kernel/exec.c</code> 中的 return argc 之前插入 if(p-&gt;pid==1) vmprint(p-&gt;pagetable)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/exec.c</span></span><br><span class="line">........</span><br><span class="line"><span class="keyword">if</span>(p-&gt;pid == <span class="number">1</span>) vmprint(p-&gt;pagetable);</span><br><span class="line">  <span class="keyword">return</span> argc; <span class="comment">// this ends up in a0, the first argument to main(argc, argv)</span></span><br><span class="line">........</span><br></pre></td></tr></table></figure>

<h2 id="Detecting-which-pages-have-been-accessed-hard"><a href="#Detecting-which-pages-have-been-accessed-hard" class="headerlink" title="Detecting which pages have been accessed (hard)"></a>Detecting which pages have been accessed (hard)</h2><p>通过 PTE_A，检测哪些页面已被访问。</p>
<blockquote>
<p>添加一个新功能，该功能通过检查 RISC-V 页表中的访问位来检测并向用户空间报告此信息。RISC-V 硬件页面遍历器在解决 TLB 未命中时在 PTE 中标记这些位。</p>
</blockquote>
<blockquote>
<p>Your job is to implement pgaccess(), a system call that reports which pages have been accessed. The system call takes three arguments. First, it takes the starting virtual address of the first user page to check. Second, it takes the number of pages to check. Finally, it takes a user address to a buffer to store the results into a bitmask (a datastructure that uses one bit per page and where the first page corresponds to the least significant bit). You will receive full credit for this part of the lab if the pgaccess test case passes when running pgtbltest.</p>
</blockquote>
<p>在 <code>kernel/sysproc.c</code> 中定义 <code>sys_pgaccess()</code>，返回一个整数，整数的第 0 位为 1 就代表页面 0 已被访问，第 1 位为 1 就代表页面 1 已被访问…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/sysproc.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LAB_PGTBL</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_pgaccess</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// lab pgtbl: your code here.</span></span><br><span class="line">  uint64 page_start;  <span class="comment">// 页表起始指针</span></span><br><span class="line">  <span class="keyword">int</span> page_num;       <span class="comment">// 页表个数</span></span><br><span class="line">  uint64 user_addr;   <span class="comment">// 稍后会通过 copyout 写入用户内存</span></span><br><span class="line">  <span class="keyword">if</span> (argaddr(<span class="number">0</span>, &amp;page_start) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (argint (<span class="number">1</span>, &amp;page_num)   &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (argaddr(<span class="number">2</span>, &amp;user_addr)  &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  </span><br><span class="line">  uint64 bitmap = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">proc</span> *<span class="title">p</span> =</span> myproc();</span><br><span class="line">  <span class="keyword">pagetable_t</span> pagetable = p-&gt;pagetable;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; page_num; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">pte_t</span> *pte = walk(pagetable, ((uint64)page_start) + (uint64)PGSIZE * i, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (pte != <span class="number">0</span> &amp;&amp; ((*pte) &amp; PTE_A))</span><br><span class="line">    &#123;</span><br><span class="line">      bitmap |= <span class="number">1</span> &lt;&lt; i;</span><br><span class="line">      *pte ^= PTE_A; <span class="comment">// 清除 PTE_A</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> copyout(p-&gt;pagetable, user_addr, (<span class="keyword">char</span> *)&amp;bitmap, <span class="keyword">sizeof</span>(bitmap));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>在 <code>kernel/defs.h</code> 中添加 <code>walk()</code> 声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/defs.h</span></span><br><span class="line">.........</span><br><span class="line"><span class="comment">// vm.c</span></span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">kvminit</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">kvminithart</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">kvmmap</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64, uint64, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">mappages</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64, uint64, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">pagetable_t</span>     <span class="title">uvmcreate</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">uvminit</span><span class="params">(<span class="keyword">pagetable_t</span>, uchar *, uint)</span></span>;</span><br><span class="line"><span class="function">uint64          <span class="title">uvmalloc</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64)</span></span>;</span><br><span class="line"><span class="function">uint64          <span class="title">uvmdealloc</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">uvmcopy</span><span class="params">(<span class="keyword">pagetable_t</span>, <span class="keyword">pagetable_t</span>, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">uvmfree</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">uvmunmap</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, uint64, <span class="keyword">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">uvmclear</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64)</span></span>;</span><br><span class="line"><span class="function">uint64          <span class="title">walkaddr</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">copyout</span><span class="params">(<span class="keyword">pagetable_t</span>, uint64, <span class="keyword">char</span> *, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">copyin</span><span class="params">(<span class="keyword">pagetable_t</span>, <span class="keyword">char</span> *, uint64, uint64)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span>             <span class="title">copyinstr</span><span class="params">(<span class="keyword">pagetable_t</span>, <span class="keyword">char</span> *, uint64, uint64)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>            <span class="title">vmprint</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable)</span></span>; <span class="comment">// 添加</span></span><br><span class="line"><span class="function"><span class="keyword">pte_t</span> *         <span class="title">walk</span><span class="params">(<span class="keyword">pagetable_t</span> pagetable, uint64 va, <span class="keyword">int</span> alloc)</span></span>; <span class="comment">// 添加</span></span><br><span class="line">..........</span><br></pre></td></tr></table></figure>

<p>在 <code>kernel/riscv.h</code> 中定义 <code>PTE_A</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/riscv.h</span></span><br><span class="line">.........</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTE_A	(1L &lt;&lt; 6)</span></span><br></pre></td></tr></table></figure>

<h2 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h2><p>创建文件 <code>answers-pgtbl.txt</code> 写下实验问题的答案（如果字数太少会被检测出来，哈哈不要问我为什么知道），创建文件 <code>time.txt</code> 写入实验时间。make grade 评分：</p>
<p><img src="/2022/04/19/2022-4-19/2022-4-19_3.png"></p>
<p><code>Test usertests</code> 的时候要等一段时间，不要忘记 git commit 提交。</p>
<h2 id="实验总结"><a href="#实验总结" class="headerlink" title="实验总结"></a>实验总结</h2><p>总算是对进程和页表有更深的了解了，实验还在继续… 燃烧我的 OS！</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>黎酝
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://liyun-666.github.io/2022/04/19/2022-4-19/" title="Lab Page tables">https://liyun-666.github.io/2022/04/19/2022-4-19/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/MIT-6-S081/" rel="tag"># MIT 6.S081</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/04/16/2022-4-16/" rel="prev" title="Lab System calls">
                  <i class="fa fa-chevron-left"></i> Lab System calls
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/04/20/2022-4-20/" rel="next" title="Lab Traps">
                  Lab Traps <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2022-01 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">黎酝</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div><script color="0,0,255" opacity="0.5" zIndex="-1" count="99" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


    </div>
  </footer>

  
  <script size="300" alpha="0.6" zIndex="-1" src="https://cdn.jsdelivr.net/npm/ribbon.js@1.0.2/dist/ribbon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  





  





  
  

  <script async src="/js/cursor/fireworks.js"></script>


</body>
</html>
